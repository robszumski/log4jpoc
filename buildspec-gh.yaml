version: 0.2

env:
  shell: bash
  variables:
    IMAGE_TAG: '2.14.1'
    IMAGE: 'quay.io/robszumski/log4jpoc'
    NAME: 'log4jpoc-codebuild'
    EDGEBIT_URL: 'https://rob.edgebit.io'
    GH_REPO: 'https://github.com/robszumski/log4jpoc'
  secrets-manager:
    EDGEBIT_API_KEY: rob.edgebit.io/EdgeBitAPIKey
    GH_TOKEN: robszumski/GitHub/AccessToken

phases:
  install:
    commands:
      # Install ebctl v0.5.1
      - curl -sL https://install.edgebit.io/releases/edgebit-cli/latest/edgebit-cli_Linux_x86_64.tar.gz --output ebctl.tar.gz
      - tar -xvf ebctl.tar.gz
      - chmod +x ebctl
      # Install syft v0.74.1
      - curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b . v0.74.1
      # Install gh CLI
      - echo "Installing gh CLI"
      - |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && apt update \
        && apt install gh -y
  pre_build:
    commands:
      # Gather GitHub details
      - LATEST_SHA=$(git rev-parse HEAD)
      - GH_DEFAULT_BRANCH=$(gh repo view --json defaultBranchRef edgebitio/platform | jq -r .defaultBranchRef.name)
      - GH_IS_DEFAULT=$(git merge-base --is-ancestor HEAD origin/$GH_DEFAULT_BRANCH && echo "1")
      - GH_PR_NUMBER=$(gh pr list --repo $REPO --search $LATEST_SHA --json number --jq .[].number)
      - |
          if [[ "$GH_IS_DEFAULT" = 1 ]]; then
            EDGEBIT_EXTRA_TAG="--tag latest"
          else
            EDGEBIT_EXTRA_TAG="--tag pr-${GH_PR_NUMBER}"
          fi
      - FULL_IMAGE="$IMAGE:$IMAGE_TAG"
  build:
    commands:
      - docker build -t $FULL_IMAGE .
      # Generate SBOM
      - ./syft packages $FULL_IMAGE -o syft > $NAME.syft
      # Upload SBOM for diff-ing
      - ./ebctl upload-sbom --component $NAME $EDGEBIT_EXTRA_TAG --tag $AMD_TAG --repo $REPO --commit $LATEST_SHA --image-tag $FULL_IMAGE $NAME.syft
